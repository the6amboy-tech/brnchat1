<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brindavan Pro Connect</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary-color: #007bff; --danger-color: #dc3545; --bg-color: #121212; }
        body { margin: 0; background-color: var(--bg-color); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* VIDEO AREA */
        .video-container { position: relative; flex: 1; display: flex; justify-content: center; align-items: center; background: #000; }
        
        /* Friend's Video (Full Screen) */
        #remote-video { width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        
        /* Your Video (Floating Picture-in-Picture) */
        #local-video { position: absolute; bottom: 100px; right: 20px; width: 180px; height: 120px; object-fit: cover; border-radius: 12px; border: 2px solid rgba(255,255,255,0.3); background: #333; transform: scaleX(-1); box-shadow: 0 8px 20px rgba(0,0,0,0.5); transition: all 0.3s ease; z-index: 10; }
        #local-video:hover { transform: scaleX(-1) scale(1.05); border-color: #fff; }

        /* CONTROL BAR */
        .controls-bar { height: 80px; background: #1e1e1e; display: flex; justify-content: center; align-items: center; gap: 20px; padding-bottom: 20px; }
        
        .btn-control { width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 20px; color: white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; background: #333; }
        .btn-control:hover { background: #555; transform: translateY(-2px); }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: #bb2d3b; }
        .btn-active { background: var(--primary-color); }
        
        /* OVERLAY MESSAGES */
        .status-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 30px; border-radius: 15px; text-align: center; z-index: 20; backdrop-filter: blur(5px); border: 1px solid #333; }
        .status-overlay h2 { margin-top: 0; }
        .invite-link-box { background: #333; padding: 10px; border-radius: 5px; margin: 15px 0; font-family: monospace; user-select: all; color: #00ff88; word-break: break-all; }
        .hidden { display: none !important; }
        
        /* MOBILE ADJUSTMENTS */
        @media (max-width: 600px) {
            #local-video { width: 120px; height: 160px; bottom: 90px; right: 10px; }
            .btn-control { width: 45px; height: 45px; font-size: 18px; }
        }
    </style>
</head>
<body>

    <div class="video-container">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>

        <div id="welcome-panel" class="status-overlay">
            <h2>Waiting for friend...</h2>
            <p>Share this link to start the call:</p>
            <div id="invite-link" class="invite-link-box">Generating link...</div>
            <button class="btn-control btn-active" style="width: auto; padding: 0 30px; border-radius: 30px;" onclick="copyLink()">
                <i class="fas fa-copy"></i> &nbsp; Copy Link
            </button>
        </div>

        <div id="join-panel" class="status-overlay hidden">
            <h2>Ready to Join?</h2>
            <p>You are about to enter the call.</p>
            <button class="btn-control btn-active" style="width: auto; padding: 0 40px; border-radius: 30px;" onclick="joinCall()">
                <i class="fas fa-video"></i> &nbsp; Join Now
            </button>
        </div>
    </div>

    <div class="controls-bar">
        <button class="btn-control" onclick="toggleAudio()" id="btn-audio" title="Mute/Unmute">
            <i class="fas fa-microphone"></i>
        </button>
        <button class="btn-control" onclick="toggleVideo()" id="btn-video" title="Show/Hide Camera">
            <i class="fas fa-video"></i>
        </button>
        <button class="btn-control btn-danger" onclick="endCall()" title="End Call">
            <i class="fas fa-phone-slash"></i>
        </button>
    </div>

    <script>
        const peer = new Peer(); 
        let myStream;
        let currentCall;
        const urlParams = new URLSearchParams(window.location.search);
        const friendId = urlParams.get('call');

        // UI Elements
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const welcomePanel = document.getElementById('welcome-panel');
        const joinPanel = document.getElementById('join-panel');
        const inviteLinkBox = document.getElementById('invite-link');

        // 1. Start Media (Camera/Mic)
        navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
            myStream = stream;
            localVideo.srcObject = stream;

            peer.on('open', (id) => {
                if (!friendId) {
                    // YOU ARE HOST
                    const link = window.location.href.split('?')[0] + '?call=' + id;
                    inviteLinkBox.innerText = link;
                } else {
                    // YOU ARE GUEST
                    welcomePanel.classList.add('hidden'); // Hide waiting screen
                    joinPanel.classList.remove('hidden'); // Show join button
                }
            });

            // 2. Incoming Call Handler
            peer.on('call', (call) => {
                welcomePanel.classList.add('hidden'); // Hide waiting message
                call.answer(stream); // Answer with our stream
                handleCall(call);
            });

        }).catch(err => {
            alert("Please allow Camera and Microphone access to use this app.");
        });

        // 3. Join Call Function (Guest)
        function joinCall() {
            joinPanel.classList.add('hidden');
            const call = peer.call(friendId, myStream);
            handleCall(call);
        }

        // 4. Handle Stream Logic
        function handleCall(call) {
            currentCall = call;
            call.on('stream', (remoteStream) => {
                remoteVideo.srcObject = remoteStream;
            });
            call.on('close', () => {
                alert("Call Ended");
                location.reload();
            });
        }

        // 5. Button Features
        function toggleAudio() {
            const audioTrack = myStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            document.getElementById('btn-audio').innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            document.getElementById('btn-audio').style.background = audioTrack.enabled ? '#333' : '#dc3545';
        }

        function toggleVideo() {
            const videoTrack = myStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
            document.getElementById('btn-video').innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
            document.getElementById('btn-video').style.background = videoTrack.enabled ? '#333' : '#dc3545';
        }

        function copyLink() {
            navigator.clipboard.writeText(inviteLinkBox.innerText).then(() => alert("Link Copied!"));
        }

        function endCall() {
            if(currentCall) currentCall.close();
            window.location.href = window.location.pathname; // Go back to home
        }
    </script>
</body>
</html>
